<!DOCTYPE html>
<html>
<head>
<title>:: 스케줄러 ::</title>
<meta charset='utf-8' />
<link href='css/fullcalendar.min.css' rel='stylesheet' />
<link href='css/fullcalendar.print.min.css' rel='stylesheet' media='print' />
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" />

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script> 
<script src="http://land.dp25.kr/land/js/common.js"></script>
<script src="http://land.dp25.kr/land/js/iplocation.js"></script>
<script src='js/moment.min.js'></script>
<script src='js/fullcalendar.min.js'></script>
<script src='js/locale-all.js'></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>


<script type="text/javascript">
var text = "";	//json 원본
var jsondata = []; 	//json에서 data obj
var callEvent = "";
var daytime = [];
var cheat = $.getP("cheat");	//admin, teamleader, 
var grade = "";
var sortingField = "index";	//정렬 기준

$.ajax({
    url: 'https://schedule-monometallic-encopresis.devpack.co.kr/api/schedule/list/',
    dataType: 'json',
    success: function(data) {
    	text = data;
		text.sort(function(a, b){	//index 오름차순
			return a[sortingField] - b[sortingField];
		});
        //alert("성공");		
		calendarEvent(text);
    },
	error : function(error){
		alert("에러!! 값:"+error);
		console.log(error);
	},
});
/*
10:00:00~11:00:00
10:00:00~12:00:00
10:00:00~13:00:00
10:00:00~14:00:00
10:00:00~15:00:00
10:00:00~16:00:00
10:00:00~17:00:00
10:00:00~18:00:00

11:00:00~12:00:00
11:00:00~13:00:00
11:00:00~14:00:00
11:00:00~15:00:00
11:00:00~16:00:00
11:00:00~17:00:00
11:00:00~18:00:00

12:00:00~13:00:00
12:00:00~14:00:00
12:00:00~15:00:00
12:00:00~16:00:00
12:00:00~17:00:00
12:00:00~18:00:00

13:00:00~14:00:00
13:00:00~15:00:00
13:00:00~16:00:00
13:00:00~17:00:00
13:00:00~18:00:00

14:00:00~15:00:00
14:00:00~16:00:00
14:00:00~17:00:00
14:00:00~18:00:00

15:00:00~16:00:00
15:00:00~17:00:00
15:00:00~18:00:00

16:00:00~17:00:00
16:00:00~18:00:00

17:00:00~18:00:00
*/

//시간 중복 막기
function daySchedule(titleval,indexval){
	var day = $("#schedule-date").text();
	var time = [];	
	var time2 = [];	
	var startTime = "";
	var endTime  = "";
	var notime =[];
	
	$.each(jsondata, function(i,val){		
		if(jsondata[i].start.match(day)){	//클릭한 날짜의 스케줄 			
			if(jsondata[i].title != "연차"){	//연차 빼고
				if(jsondata[i].title == titleval){	//같은 회의 끼리만 
					if(jsondata[i].index != indexval)	//현재 설정한 시간 빼고
					startTime = parseFloat(jsondata[i].startIdx);	//실수형으로 대입
					endTime = parseFloat(jsondata[i].endIdx);	
					time.push(startTime);
					time2.push(endTime);					
					//daytime.push(startTime+"~"+endTime); 						
					console.log(jsondata[i]);
					//console.log(time);
					//console.log(time2);
				}
			}
		}
	});
	
	//불가능한 start 시간 
	$.each(time, function(i,val){
		//for(var n=time[i]; n<time2[i];n++){
		for(var n = parseFloat(time[i]); n<parseFloat(time2[i]);n+=0.5){	//실수형으로 계산
			notime.push(Number(n));
			console.log(notime);
		}
	});
	overlapTest(notime)
	return notime;
}

//중복 제거 
function overlapTest(arr){
	var uniqueNames = [];
	$.each(arr, function(i, el){
		if($.inArray(el, uniqueNames) === -1) uniqueNames.push(el);
	});
	return uniqueNames;
}

function calendarEvent(eventData){
	$.each(eventData, function(i, val) { 
		var arrVal = eventData[i].data;
		jsondata.push(arrVal);
	});	
	
	//console.log(eventData)
	$("#calendar").html("");
	var date = new Date();
	var d = date.getDate();
	var m = date.getMonth();
	var y = date.getFullYear();
	var calendar = $('#calendar').fullCalendar({
		lang: "ko",
		header: {
			left: "title prev,next today",
			center: "title",
			//right: "month,basicWeek,basicDay"
			right: "",
		},
		eventLimit: true,
		selectable: true,
		selectHelper: true,
		editable: true,		
		titleFormat: "YYYY년 MMMM",	//2018년 1월
		//allDayDefault: false,
		defaultView: "month",		
		monthNames: ["1월","2월","3월","4월","5월","6월","7월","8월","9월","10월","11월","12월"],
		monthNamesShort: ["1월","2월","3월","4월","5월","6월","7월","8월","9월","10월","11월","12월"],
		dayNames: ["일요일","월요일","화요일","수요일","목요일","금요일","토요일"],
		dayNamesShort: ["일","월","화","수","목","금","토"],
		buttonText: {
			today : "오늘",
			month : "월별",
			week : "주별",
			day : "일별",
		},
		//events : eventData,
		events: jsondata,
		/*events:[
			{
				title: "개련이",
				start: "2018-01-25",
				end: "2018-01-26"
			}
			
		],*/
		eventRender: function(event, eventElement) {	//스케줄 랜더링 시작
			if(event.title) eventElement.find(".fc-title").html(event.title+" ");	//띄어쓰기
			if(event.title != "연차") eventElement.find(".fc-time").html(eventElement.find(".fc-time").html()+" ");	//띄어쓰기
			if(event.memo) eventElement.find(".fc-title").after($("<span class=\"fc-memo\"></span>").html(event.memo));
			//eventElement.find(".fc-time").insertAfter(eventElement.find(".fc-title"));
			eventElement.find(".fc-time").appendTo(eventElement.find(".fc-title"));	//순서 바꿔주기
			if(event.title == "연차") eventElement.find(".fc-time").css({"display" : "none"});	//연차는 시간 안보이기
			
			//eventElement.find(".fc-time").clone().appendTo(eventElement.find(".fc-title"));    
			//console.log(event);
			//console.log(eventElement);
		},
		eventClick: function(calEvent, jsEvent, view) {	//일정 수정
			//리스트 순서가 1.start 제일 낮은순 2.start와 end 사이 시간이 긴 순
			callEvent = calEvent;	//클릭한 일정 데이터
			console.log(calEvent);			
			//console.log(jsEvent);
			//console.log(view);
			$("#action-btn").text("수정");			
			$("#action-btn3").addClass("none");
			$("#action-btn2").removeClass("none");
			$("#schedule [name=action]").val("mod");	//수정
			$("#schedule [name=index]").val(callEvent.index);
			$("#schedule [name=title]").val(callEvent.title);
			$("#schedule [name=memo]").val(callEvent.memo);
			$("#schedule [name=writer]").val(callEvent.writer).attr("readonly", "readonly");
			$("#schedule [name=title]").removeAttr("disabled");	//구분
			if($("#schedule [name=title]").val() =="연차") $("#schedule [name=title]").attr("disabled","true");
			var startDate = callEvent.start._i.split(" ");
			$("#schedule [name=start-time]").val(startDate[1]);
			var endDate = callEvent.end._i.split(" ");
			$("#schedule [name=end-time]").val(endDate[1]);
			$("#schedule-date").text(startDate[0]);
			$("#schedule-title").text("스케줄 상세");
			$("#dataModal").modal("show");
			//alert('Event: ' + calEvent.title);
			//alert('Coordinates: ' + jsEvent.pageX + ',' + jsEvent.pageY);
			//alert('View: ' + view.name);
		},
		dayClick: function(date, jsEvent, view) {	//일정 추가 
			callEvent = ""; //callEvent 초기화 
			var addIndex = parseInt(jsondata[jsondata.length - 1].index) + 1;
			console.log(addIndex);
			console.log(date);
			//console.log('Clicked on: ' + date.format());
			console.log(jsEvent);
			console.log(view);
			$("#action-btn").text("추가");
			$("#action-btn2").addClass("none");
			$("#action-btn3").removeClass("none");			
			$("#schedule-date").text(date.format());
			$("#schedule input").val(""); 
			$("#schedule [name=index]").val(addIndex);
			$("#schedule [name=action]").val("add");	//추가
			$("#schedule [name=start-time]").val($("#schedule [name=start-time] option:eq(0)").val());
			$("#schedule [name=end-time]").val($("#schedule [name=end-time] option:eq(0)").val());
			$("#schedule [name=title]").val($("#schedule [name=title] option:eq(0)").val());
			$("#schedule-title").text("스케줄 추가");
			$("#schedule [name=writer]").removeAttr("readonly");
			$("#schedule [name=title]").removeAttr("disabled");	//구분 			
			$("#dataModal").modal("show");
		},
		timeFormat : "HH:mm",
	});
}


//스케줄 수정, 등록
function schedule_submit(){
	var mode = $("#schedule [name=action]").val();
	//var scheduleData = $("#schedule").serialize(); 
	//console.log(scheduleData);
	var start = $("#schedule-date").text()+" "+$("#schedule [name=start-time]").val();
	var end = $("#schedule-date").text()+" "+$("#schedule [name=end-time]").val();
	var startIdx = $("#schedule [name=start-time] option:selected").attr("idx");
	var endIdx = $("#schedule [name=end-time] option:selected").attr("idx");
	var title = $("#schedule [name=title] option:selected").val();
	var color = $("#schedule [name=title] option:selected").attr("color");
	var memo = $("#schedule [name=memo]").val();
	var writer = $("#schedule [name=writer]").val();
	var index =$("#schedule [name=index]").val();
	
	if(grade < "90"){
		alert("권한이 없습니다.");
		return false;
	}
	if(title =="연차"){
		start = $("#schedule-date").text()+" 08:00:00";
		end = $("#schedule-date").text()+" 09:00:00";
		if(grade < "95"){
			alert("권한이 없습니다.");
			return false;
		}
	}
	console.log(startIdx);
	console.log(endIdx);	
	if(startIdx >= endIdx){
		alert("예약 시간이 이상합니다. 다시 한번 확인 해보세요~");
		return false;
	}
	
	if(!memo){
		alert("내용을 입력해 주세요.");
		return false;
	}
	if(!writer){
		alert("작성자를 입력해 주세요.");
		return false;
	}
	//중복 값 가져오기
	var overlap = daySchedule(title,callEvent.index);
	console.log(overlap)
	console.log(startIdx)	
	
	if($.inArray(parseFloat(startIdx), overlap) != -1){	//startIdx 실수형으로
		alert("중복된 시간입니다. 다른 시간으로 예약 해주세요~");
		return false;
	}	
	//return false;
	if(mode =="add"){	//추가일 때
		$.ajax({
            url: "https://schedule-monometallic-encopresis.devpack.co.kr/api/schedule/add/",
			//url: "http://localhost:3000/api/crm_user",
            type: "POST",
            data: {"start" : start, "end" : end, "title" : title, "color" : color, "memo" : memo, "writer" : writer, "index" : index, "startIdx" : startIdx, "endIdx" : endIdx},
            contentType: "application/x-www-form-urlencoded; charset=UTF-8", 
            dataType: "json",	//json으로 하면 되고, 아예 타입 안정해도 되는데, jsonp로는 안됨
			error : function(error){
				alert("에러!! 값:"+error);
				console.log(error);
			},
            success : function (data) { 

                alert("등록되었습니다 값:"+data.result);
				console.log(data);
				location.href = location.href;
                //go("/dash.html?code=b");

            }

        });
		
	}else if(mode =="mod"){	//수정일 때
		$.ajax({
            url: "https://schedule-monometallic-encopresis.devpack.co.kr/api/schedule/mod/"+index,
			//url: "http://localhost:3000/api/crm_user",
            type: "PUT",
            data: {"start" : start, "end" : end, "title" : title, "color" : color, "memo" : memo, "writer" : writer, "index" : index, "startIdx" : startIdx, "endIdx" : endIdx},
            contentType: "application/x-www-form-urlencoded; charset=UTF-8", 
            dataType: "json",	//json으로 하면 되고, 아예 타입 안정해도 되는데, jsonp로는 안됨
			error : function(error){
				alert("에러!! 값:"+error);
				console.log(error);
			},
            success : function (data) { 

                alert("수정하였습니다. 값:"+data.result);
				console.log(data);
				location.href = location.href;
                //go("/dash.html?code=b");

            }

        });
	}
}
//스케줄 삭제
function schedule_delete(){
	var index =$("#schedule [name=index]").val();
	
	if(grade < "90"){
		alert("권한이 없습니다.");
		return false;
	}
	
	if($("#schedule [name=title]").val() == "연차"){
		if(grade < "95"){
			alert("권한이 없습니다.");
			return false;
		}
	}
	
	if(confirm("삭제하시겠습니까?")){
		$.ajax({
			url: "https://schedule-monometallic-encopresis.devpack.co.kr/api/schedule/del/"+index,
			//url: "http://localhost:3000/api/crm_user",
			type: "DELETE",		
			contentType: "application/x-www-form-urlencoded; charset=UTF-8", 
			dataType: "json",	//json으로 하면 되고, 아예 타입 안정해도 되는데, jsonp로는 안됨
			error : function(error){
				alert("에러!! 값:"+error);
				console.log(error);
			},
			success : function (data) { 

				alert("삭제 되었습니다");
				location.href = location.href;
				//go("/dash.html?code=b");

			}

		});
	}else{
		return false;
	}
}

$(function(){
	if(cheat){
		if(cheat == "chairman") grade = "99";
		if(cheat == "management") grade = "98";
		if(cheat == "alliance") grade = "91";
		if(cheat == "teamleader") grade = "90";
		alert(cheat);
	}
	/*title 셀렉트박스 제어 
	$("#schedule [name=title]").on("click", function(){ 		
		var val = $(this).val();
		if(val =="연차"){
			alert("권한이 없습니다.")
			return false;
		}else{
			
		}		
	});
	$("#schedule [name=title]").on("change", function(){ 		
		var val = $(this).val();
		if(val =="연차"){
			alert("권한이 없습니다.")
			return false;
		}else{
			
		}		
	});
	*/
});

</script>

<style>

	body {
		margin: 40px 10px;
		padding: 0;
		font-family: "Lucida Grande",Helvetica,Arial,Verdana,sans-serif;
		font-size: 14px;
	}

	#calendar {
		max-width: 1100px;
		margin: 0 auto;
	}
	.fc-center{margin-right:27%;}/*메인 날짜*/
	.modal{top:24%;}
	.modal-dialog{width:300px;}
	.select-time{width:47%; display:inline;}
	.fc-title{font-weight:bold;}
	.fc-time{font-weight:normal !important;}
	#schedule-date{text-align:center;}
	.fc-day-number{cursor:pointer;}
	.none{display:none;}
	#schedule-title{cursor:pointer;}
</style>
</head>
<body>	
  <div id='calendar'></div>
  
	<div id="dataModal" class="modal fade">
		<div class="modal-dialog">
			<div class="modal-content">
			<!-- 모달 헤더 -->
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">&times;</button>
					<h4 class="modal-title" id="schedule-title">스케줄 상세</h4>
				</div>
				<!-- 모달 바디 -->
				<div class="modal-body" id="employee_detail">
					<form id="schedule" method="post">
						<input type="hidden" name="index" value=""/>					
						<input type="hidden" name="action" value=""/>
						<input type="hidden" name="date" value=""/>
						<label>일자</label>
						<p id="schedule-date"></p>
						<label>구분</label>
						<select name="title" class="form-control">
							<option value="회의大">회의大</option>
							<option value="회의小">회의小</option>
							<!--option value="연차" color="green" class="none">연차</option-->
							<option value="연차" color="green">연차</option>
						</select>					
						<label>내용</label>
						<input type="text" name="memo" class="form-control" />
						<label>작성자</label>
						<input type="text" name="writer" class="form-control" />
						<div id="schedule-time">
							<label>시간</label>
							<br/>
							<select name="start-time" class="form-control select-time">
								<option value="10:00:00" idx="10.0">10:00</option>
								<option value="10:30:00" idx="10.5">10:30</option>
								<option value="11:00:00" idx="11.0">11:00</option>
								<option value="11:30:00" idx="11.5">11:30</option>
								<option value="12:00:00" idx="12.0">12:00</option>
								<option value="12:30:00" idx="12.5">12:30</option>
								<option value="13:00:00" idx="13.0">13:00</option>
								<option value="13:30:00" idx="13.5">13:30</option>
								<option value="14:00:00" idx="14.0">14:00</option>
								<option value="14:30:00" idx="14.5">14:30</option>
								<option value="15:00:00" idx="15.0">15:00</option>
								<option value="15:30:00" idx="15.5">15:30</option>
								<option value="16:00:00" idx="16.0">16:00</option>
								<option value="16:30:00" idx="16.5">16:30</option>
								<option value="17:00:00" idx="17.0">17:00</option>
								<option value="17:30:00" idx="17.5">17:30</option>
								<option value="18:00:00" idx="18.0">18:00</option>								
							</select>
							<label>~</label>
							<select name="end-time" class="form-control select-time">
								<option value="10:30:00" idx="10.5">10:30</option>
								<option value="11:00:00" idx="11.0">11:00</option>
								<option value="11:30:00" idx="11.5">11:30</option>
								<option value="12:00:00" idx="12.0">12:00</option>
								<option value="12:30:00" idx="12.5">12:30</option>
								<option value="13:00:00" idx="13.0">13:00</option>
								<option value="13:30:00" idx="13.5">13:30</option>
								<option value="14:00:00" idx="14.0">14:00</option>
								<option value="14:30:00" idx="14.5">14:30</option>
								<option value="15:00:00" idx="15.0">15:00</option>
								<option value="15:30:00" idx="15.5">15:30</option>
								<option value="16:00:00" idx="16.0">16:00</option>
								<option value="16:30:00" idx="16.5">16:30</option>
								<option value="17:00:00" idx="17.0">17:00</option>
								<option value="17:30:00" idx="17.5">17:30</option>
								<option value="18:00:00" idx="18.0">18:00</option>
							</select>
						</div>
					</form>
				</div>

				<!-- 모달 풋터 -->
				<div class="modal-footer">
					<button type="button" class="btn btn-default" style="margin-right:56%;" id="action-btn" onclick="schedule_submit();return false;">추가</button>
					<button type="button" class="btn btn-default" id="action-btn2" onclick="schedule_delete();return false;">삭제</button>
					<button type="button" class="btn btn-default" data-dismiss="modal" id="action-btn3">닫기</button>
				</div>
			</div>
		</div>
	</div>

  <div id="add_data_Modal" class="modal fade">
		<div class="modal-dialog">
			<div class="modal-content">

			<!-- 모달 헤더 -->
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">&times;</button>
					<h4 class="modal-title">php ajax데이터를 부트스트랩 모달을 이용해서 mysql에 추가하기</h4>
				</div>

				<!-- 모달 바디 -->
				<div class="modal-body">
					<form method="post" id="insert_form">
						<label>이름</label>
						<input type="text" name="name" id="name" class="form-control" />
						<br />
						<label>주소</label>
						<textarea name="address" id="address" class="form-control" ></textarea>
						<br />

						<label>성별</label>
						<select name="gender" id="gender">
							<option value="남성">남성</option>
							<option value="여성">여성</option>
						</select>
						<br />
						<br />
						<label>직업</label>
						<input type="text" name="designation" id="designation" class="form-control" />
						<br />
						<label>나이</label>
						<input type="text" name="age" id="age" class="form-control" />
						<br />

						<input type="submit" name ="insert" id="insert" value="추가" class="btn btn-success" />

					</form>
				</div>

				<!-- 모달 풋터 -->
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">닫기</button>
				</div>

			</div>
		</div>
	</div>
</body>
</html>
